# GATK mutect2
# This pipeline is for running Mutect2 from GATK4.2.5, annotating and then subsetting to CGC genes of interest
# These are WGS data of tRCC pateints on 18 samples
# The first pipeline is variant calls using Mutect2 for a single sample run followed by filtering and annotation with SnpEff

#!/bin/bash
source /etc/profile
#$ -S /bin/bash
#$ -pe pvm 8

#modules GATK, miniconda and picard loaded 
#module used are as follows, comment out when necessary

module load /mnt/storage/spack/share/spack/modules/linux-ubuntu16.04-x86_64/gatk-4.2.5.0-gcc-5.4.0-tfxkdz3

# run mutect2 with gatk

gatk --java-options "-Xmx100G" Mutect2 \
-R /path/to/Homo_sapiens_assembly38.fasta \
-I /path/to/tumor.cram \
-tumor tumor_name \
-I /path/to/normal.cram \
-normal normal_name \
--germline-resource /path/to/af-only-gnomad.hg38.vcf.gz \
--panel-of-normals /path/to/1000g_pon.hg38.vcf.gz \
--f1r2-tar-gz /path/to/f1r2.tar.gz \
-O /path/to/somatic.vcf.gz

# for filtering-

# read oreintation filters, this can be run at the end too but before filtering!

gatk LearnReadOrientationModel 
-I /path/to/f1r2.tar.gz 
-O /path/to/read-orientation-model.tar.gz \

# getpileup summaries for tumor 
gatk GetPileupSummaries \
-R /path/to/Homo_sapiens_assembly38.fasta \
-I /path/to/tumor.cram \
-V /path/to/small_exac_common_3.hg38.vcf.gz \
-L /path/to/small_exac_common_3.hg38.vcf.gz \
-O /path/to/tum_pileup.table \

# getpileup summaries for normal
# uses matched normal
gatk GetPileupSummaries \
-R /path/to/Homo_sapiens_assembly38.fasta \
-I /path/to/norm.cram \
-V /path/to/small_exac_common_3.hg38.vcf.gz \
-L /path/to/small_exac_common_3.hg38.vcf.gz \
-O /path/to/norm_pileup.table \

# calculate contamination
gatk CalculateContamination \
-I /path/to/tum_pileup.table \
-matched/path/to/norm_pileup.table \
-O /path/to/matched_contamination_table \
-tumor-segmentation /path/to/tum_segments.table \

# filter mutect calls after adding segments table, tumor segmentation table while filtering is optional
# previously I didn't add tumor segmentation table while filtering, this tumor segmentation tabel is generated by calculate contamination
# when run with without tumor segmentation, with this table reduces no. of variants but its optional

# final filtering steps

gatk FilterMutectCalls \
-R /path/to/Homo_sapiens_assembly38.fasta \
-V /path/to/somatic.vcf.gz \
# -tumor-segmentation /path/to/tum_segments.table \
--contamination-table /path/to/matched_contamination_table \
--ob-priors /path/to/read-orientation-model.tar.gz \
-O /path/to/matched_somatic.vcf.gz

# from this filtered vcf, variant sites which are labelled as PASS are selected by using bcftools as those are the ones that have passed the filter 

module load /path/to/bcftools
bcftools view -i "%FILTER='PASS'" matched_somatic.vcf.gz > matched_somatic_filtered.vcf

# count the no. pass variants or analyze the stats

# annotate with VEP106 

## alternate annotation run by snpeff with gatk

java -Xmx8g -jar /path/to/snpEff_v4_3t/snpEff.jar \ 
-c /path/to/snpEff_v4_3t/snpEff.config \ 
-v hg38 /path/to/filtered_passed_seg_somatic4.2.vcf \
-o /path/to/passed_ann.vcf
